<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Refiner</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 1em;
        }
        .result {
            margin-top: 2em;
            border: 1px solid #ccc;
            padding: 1em;
        }
        .result h3 {
            margin-top: 0;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 0.8em 1.5em;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button:hover {
            background-color: #f5f5f5;
        }
        .tab-button.active {
            border-bottom-color: #1976d2 !important;
        }
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1em;
            margin-bottom: 1em;
        }
        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        /* New styles for the header and container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2em;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5em;
        }

        .header h1 {
            font-size: 1.8em;
            margin: 0;
            color: #333;
        }

        /* Session loader notification styles */
        #session-loader {
            display: none;
            margin-top: 2em;
            padding: 1em;
            border-radius: 8px;
            background-color: #e3f2fd;
            border: 1px solid #1976d2;
        }

        #session-loader h3 {
            color: #1565c0;
            margin-bottom: 1em;
        }

        #session-loader p {
            margin: 0.5em 0;
        }

        /* General button styles */
        button {
            padding: 0.6em 1.2em;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #155a8a;
        }

        /* Legacy styles - to be removed once confirmed */
        #sessionResults {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" style="height: 40px; width: 40px; margin-right: 15px;">
            <h1>Interactive Prompt Refiner</h1>
        </div>
        <p>This tool helps you refine and evaluate prompts using LLMs. Provide an initial prompt, define your objective, and the tool will iteratively improve it.</p>
        
        <form id="refinement-form">
            <label for="prompt">Initial Prompt:</label><br>
            <textarea id="prompt" name="prompt" required></textarea><br>
            <label for="attachments">Attachments (webpage.txt loaded as default):</label><br>
            <small style="color: #666; margin-bottom: 0.5em; display: block;">📎 Default attachment from webpage.txt is automatically loaded. You can modify or replace this content.</small>
            <textarea id="attachments" name="attachments">{{ default_attachment }}</textarea><br>

            <h3>Parameters</h3>
            <label for="model">Model:</label>
            <select id="model" name="model">
                <option value="gpt-5" selected>🚀 gpt-5 (Most capable)</option>
                <option value="gpt-4o">🎯 gpt-4o (Recommended)</option>
                <option value="gpt-4o-mini">💰 gpt-4o-mini (Cost‑effective)</option>
                <option value="gpt-3.5-turbo">⚡ gpt-3.5-turbo (Fast & affordable)</option>
            </select>
            <small style="color: #666; display: block; margin-top: 0.2em; margin-bottom: 1em;">
                💡 <strong>Model Guide:</strong> Use <strong>gpt-5</strong> for the highest quality results. For other needs, <strong>gpt-4o</strong> offers a great balance of capability and cost.
            </small>
            <small style="color: #666; display: block; margin-top: 0.2em; margin-bottom: 1em;">
                🔗 Sources: <a href="https://openai.com" target="_blank" rel="noopener">@OpenAI</a> ·
                <a href="https://platform.openai.com/docs/overview" target="_blank" rel="noopener">@openai_docs</a>
            </small>
            <br>
            <label for="temperature">Temperature:</label>
            <input type="range" id="temperature" name="temperature" min="0" max="2" step="0.1" value="1">
            <span id="temperature-value">1.0</span>
            <br>
            <label for="max_tokens">Max Tokens:</label>
            <input type="number" id="max_tokens" name="max_tokens" value="6000">
            <br>
            <label for="max_iterations">Max Iterations:</label>
            <input type="number" id="max_iterations" name="max_iterations" value="5" min="1" max="10">
            <br>
            <label for="iterate_until_satisfied">
                <input type="checkbox" id="iterate_until_satisfied" name="iterate_until_satisfied">
                Iterate until satisfaction is achieved (ignore max iterations)
            </label>
            <small style="color: #666; display: block; margin-left: 1.2em; margin-top: 0.2em;">⚠️ This may result in many iterations and higher costs</small>
            <br>

            <label for="evaluation_criteria">Evaluation Criteria (prompt_refinement.md loaded as default):</label>
            {% if has_default_criteria %}
            <small style="color: #28a745; margin-bottom: 0.5em; display: block;">📋 Default pharma/audio expert evaluation criteria from prompt_refinement.md is automatically loaded. You can modify or replace this content.</small>
            {% else %}
            <small style="color: #dc3545; margin-bottom: 0.5em; display: block;">⚠️ prompt_refinement.md not found - please provide your evaluation criteria or leave blank for automatic generation.</small>
            {% endif %}
            <textarea id="evaluation_criteria" name="evaluation_criteria">{{ default_evaluation_criteria }}</textarea><br>

            <button typey="submit" id="submit-btn">Start Refinement</button>
        </form>
    </div>

    <!-- Session Loader Notification -->
    <div id="session-loader" style="display: none; margin-top: 2em; padding: 1em; border-radius: 8px; background-color: #e3f2fd; border: 1px solid #1976d2;">
        <h3 style="color: #1565c0; margin-bottom: 1em;">💾 Previous Session Loaded</h3>
        <p style="margin: 0.5em 0;">Results from <strong id="session-timestamp"></strong> have been automatically loaded below.</p>
        <button onclick="document.getElementById('session-loader').style.display='none'" style="padding: 0.6em 1.2em; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Dismiss
        </button>
    </div>

    <div id="status" aria-live="polite" style="margin-top: 1em;"></div>
    <div id="progress-log" style="margin-top: 1em; background: #f5f5f5; padding: 1em; border-radius: 4px; max-height: 300px; overflow-y: auto; display: none;">
        <h4>Progress Log:</h4>
        <div id="log-content"></div>
    </div>

    <div id="results" class="result" style="display:none;">
        <h3 style="color: #1b5e20;">🎯 Refinement Results</h3>
        
        <!-- Tab Navigation -->
        <div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 1em;">
            <button class="tab-button active" onclick="showTab('final-tab', this)" style="background: none; border: none; padding: 0.8em 1.5em; cursor: pointer; font-weight: bold; border-bottom: 3px solid #1976d2;">📄 Final Result</button>
            <button class="tab-button" onclick="showTab('scores-tab', this)" style="background: none; border: none; padding: 0.8em 1.5em; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent;">📊 LLM Scores</button>
            <button class="tab-button" onclick="showTab('comparison-tab', this)" style="background: none; border: none; padding: 0.8em 1.5em; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent;">🔍 What Changed</button>
            <button class="tab-button" onclick="showTab('history-tab', this)" style="background: none; border: none; padding: 0.8em 1.5em; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent;">� Full History</button>
        </div>
        
        <!-- Final Result Tab -->
        <div id="final-tab" class="tab-content">
            <h4 style="color: #1b5e20;">🎯 Final Refined Prompt:</h4>
            <div id="refined-prompt" style="background: #f0f8ff; padding: 1em; border-radius: 4px; border-left: 4px solid #1976d2; margin-bottom: 1em; font-family: monospace; white-space: pre-wrap;"></div>
        </div>
        
        <!-- Comparison Tab -->
                
        <!-- LLM Scores Tab -->
        <div id="scores-tab" class="tab-content" style="display: none;">
            <h4 style="color: #1b5e20;">📊 LLM Evaluation Scores:</h4>
            <div id="scoresContent">
                <p style="color: #666; font-style: italic;">No scoring data available for current session</p>
            </div>
        </div>
        
        <!-- What Changed Tab -->
        <div id="comparison-tab" class="tab-content" style="display: none;">
            <h4 style="color: #1b5e20;">🔍 Original vs Refined Comparison:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1em;">
                <div>
                    <h5 style="color: #d32f2f; margin-bottom: 0.5em;">❌ Original Prompt:</h5>
                    <div id="original-prompt" style="background: #fff3e0; padding: 1em; border-radius: 4px; border-left: 4px solid #ff9800; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div>
                    <h5 style="color: #1b5e20; margin-bottom: 0.5em;">✅ Refined Prompt:</h5>
                    <div id="refined-prompt-comparison" style="background: #f0f8ff; padding: 1em; border-radius: 4px; border-left: 4px solid #1976d2; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
            <div id="diff-summary" style="background: #f5f5f5; padding: 1em; border-radius: 4px; margin-top: 1em;">
                <h5 style="margin-top: 0;">📈 Summary of Changes:</h5>
                <div id="change-stats"></div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history-tab" class="tab-content" style="display: none;">
            <h4 style="color: #1b5e20;">📊 Detailed Refinement History:</h4>
            <div id="history" style="margin-top: 1em;"></div>
        </div>
    </div>

    <!-- This section is now legacy and will not be used. -->
    <div id="sessionResults" style="display: none;"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();

        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const refinedPromptDiv = document.getElementById('refined-prompt');
        const historyDiv = document.getElementById('history');
        const submitBtn = document.getElementById('submit-btn');
        const progressLog = document.getElementById('progress-log');
        const logContent = document.getElementById('log-content');

        // New DOM Elements
        const sessionLoader = document.getElementById('session-loader');
        const sessionTimestamp = document.getElementById('session-timestamp');
        const originalPromptDisplay = document.getElementById('original-prompt');
        const refinedPromptComparisonDisplay = document.getElementById('refined-prompt-comparison');
        const changeStatsDisplay = document.getElementById('change-stats');
        const scoresContent = document.getElementById('scoresContent');


        window.addEventListener('load', () => {
            console.log("Page loaded. Checking for last session data.");
            fetch('/api/last-session')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received session data:", data);
                    if (data && data.timestamp) {
                        console.log("Session data is valid. Displaying loader and loading results.");
                        sessionTimestamp.textContent = new Date(data.timestamp).toLocaleString();
                        sessionLoader.style.display = 'block';
                        // Automatically load and display the session results
                        handleComplete(data);
                    } else {
                        console.log("No valid session data found.");
                        sessionLoader.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Error fetching last session:", error);
                    sessionLoader.style.display = 'none';
                });
        });


        socket.on('connect', function() {
            console.log('Socket.IO connected');
        });

        socket.on('disconnect', function() {
            console.log('Socket.IO disconnected');
        });

        socket.on('progress', function(data) {
            statusDiv.innerHTML = `<p> ${data.message}</p>`;
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${data.message}`;
            logContent.appendChild(logEntry);
            progressLog.scrollTop = progressLog.scrollHeight; // Auto-scroll
        });

        socket.on('complete', function(data) {
            console.log("Refinement complete. Data:", data);
            handleComplete(data);
        });

        socket.on('error', function(data) {
            statusDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Start Refinement';
        });

        document.getElementById('refinement-form').addEventListener('submit', function(e) {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Refining...';
            statusDiv.innerHTML = '<p>Starting refinement process...</p>';
            logContent.innerHTML = ''; // Clear previous logs
            progressLog.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            const formData = {
                prompt: document.getElementById('prompt').value,
                attachments: document.getElementById('attachments').value,
                model: document.getElementById('model').value,
                temperature: document.getElementById('temperature').value,
                max_tokens: document.getElementById('max_tokens').value,
                max_iterations: document.getElementById('max_iterations').value,
                iterate_until_satisfied: document.getElementById('iterate_until_satisfied').checked,
                evaluation_criteria: document.getElementById('evaluation_criteria').value
            };
            console.log("Submitting refinement request:", formData);
            socket.emit('start_refinement', formData);
        });

        function handleComplete(data) {
            statusDiv.innerHTML = '<p style="color: green; font-weight: bold;">Refinement process completed!</p>';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Start Refinement';
            progressLog.style.display = 'none';

            // Populate results
            refinedPromptDiv.textContent = data.final_prompt;
            originalPromptDisplay.textContent = data.original_prompt;
            refinedPromptComparisonDisplay.textContent = data.final_prompt;

            // Populate history
            historyDiv.innerHTML = ''; // Clear previous history
            if (data.history && data.history.length > 0) {
                data.history.forEach((item, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.style.marginBottom = '1.5em';
                    stepDiv.style.paddingBottom = '1em';
                    stepDiv.style.borderBottom = '1px solid #eee';

                    let content = `
                        <h5 style="color: #1976d2;">Iteration ${index + 1}</h5>
                        <p><strong>Critique:</strong> ${item.critique}</p>
                    `;
                    
                    // Add LLM scores if available
                    if (item.llm_scores && Object.keys(item.llm_scores).length > 0) {
                        content += `<p><strong>LLM Scores:</strong></p>`;
                        content += `<div style="background: #f8f9fa; padding: 0.5em; border-radius: 4px; margin: 0.5em 0;">`;
                        
                        const scores = item.llm_scores;
                        if (scores.overall_readiness !== undefined) {
                            content += `Overall Readiness: ${scores.overall_readiness.toFixed(1)}/10 `;
                        }
                        if (scores.confidence !== undefined) {
                            content += `| Confidence: ${scores.confidence.toFixed(1)}/10 `;
                        }
                        if (scores.content_accuracy !== undefined) {
                            content += `| Content: ${scores.content_accuracy.toFixed(1)}/10`;
                        }
                        
                        content += `</div>`;
                    }
                    
                    content += `
                        <p><strong>Refined Prompt:</strong></p>
                        <pre style="background: #f5f5f5; padding: 0.5em; border-radius: 4px; white-space: pre-wrap;">${item.refined_prompt || item.prompt}</pre>
                    `;
                    stepDiv.innerHTML = content;
                    historyDiv.appendChild(stepDiv);
                });
            } else {
                historyDiv.textContent = 'No history data available.';
            }

            // Populate scores
            scoresContent.innerHTML = '';
            console.log("Processing scores data:", data.final_scores);
            
            if (data.final_scores && Object.keys(data.final_scores).length > 0) {
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                
                let tableContent = `
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Metric</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Score</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Description</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                // Display key metrics in a user-friendly way
                const metrics = {
                    'overall_readiness': 'Overall Readiness',
                    'confidence': 'Confidence Level',
                    'content_accuracy': 'Content Accuracy',
                    'completeness': 'Completeness',
                    'audio_clarity': 'Audio Clarity',
                    'pharma_compliance': 'Pharma Compliance',
                    'refinement_quality': 'Refinement Quality',
                    'directional_correctness': 'Direction Correctness'
                };
                
                for (const [key, displayName] of Object.entries(metrics)) {
                    if (data.final_scores[key] !== undefined) {
                        const score = data.final_scores[key];
                        let description = '';
                        
                        if (typeof score === 'number') {
                            if (score >= 8) description = 'Excellent';
                            else if (score >= 6) description = 'Good';
                            else if (score >= 4) description = 'Fair';
                            else description = 'Needs Improvement';
                        }
                        
                        tableContent += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${displayName}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${typeof score === 'number' ? score.toFixed(1) : score}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${description}</td>
                            </tr>
                        `;
                    }
                }
                
                // Add reasoning if available
                if (data.final_scores.reasoning) {
                    tableContent += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Reasoning</td>
                            <td colspan="2" style="border: 1px solid #ddd; padding: 8px;">${data.final_scores.reasoning}</td>
                        </tr>
                    `;
                }
                
                tableContent += '</tbody>';
                table.innerHTML = tableContent;
                scoresContent.appendChild(table);
            } else {
                scoresContent.innerHTML = '<p style="color: #666; font-style: italic;">No scoring data available for this session.</p>';
            }

            // Calculate and display diff summary
            const originalLines = data.original_prompt.split('\n').length;
            const finalLines = data.final_prompt.split('\n').length;
            const lineChange = finalLines - originalLines;
            changeStatsDisplay.innerHTML = `
                <p><strong>Line Count:</strong> ${originalLines} ➔ ${finalLines} (${lineChange > 0 ? '+' : ''}${lineChange})</p>
            `;

            resultsDiv.style.display = 'block';
            showTab('final-tab', document.querySelector('.tab-button')); // Show the first tab by default
            sessionLoader.style.display = 'none'; // Hide loader once results are shown
        }

        function loadLastSession() {
            console.log("Loading last session...");
            statusDiv.innerHTML = '<p>Loading last session data...</p>';
            fetch('/api/last-session')
                .then(response => response.json())
                .then(data => {
                    if (data && data.final_prompt) {
                        console.log("Last session data loaded successfully:", data);
                        handleComplete(data);
                        statusDiv.innerHTML = '<p style="color: green;">Last session loaded successfully.</p>';
                    } else {
                        console.error("Failed to load valid session data.");
                        statusDiv.innerHTML = '<p style="color: red;">Could not load last session data.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading last session:', error);
                    statusDiv.innerHTML = `<p style="color: red;">Error loading session: ${error.message}</p>`;
                });
        }

        function showTab(tabId, buttonElement) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                button.style.borderBottom = '3px solid transparent';
            });
            // Show the selected tab content
            document.getElementById(tabId).style.display = 'block';
            // Activate the selected tab button
            buttonElement.classList.add('active');
            buttonElement.style.borderBottom = '3px solid #1976d2';
        }

        // This function is no longer needed as there's no persistent client-side data to clear.
        function clearSessionData() {
            console.log("Clear session data called - this function is deprecated.");
            document.getElementById('sessionResults').style.display = 'none';
        }

        document.getElementById('temperature').addEventListener('input', function(event) {
            document.getElementById('temperature-value').textContent = event.target.value;
        });

        // Handle iterate until satisfied checkbox
        document.getElementById('iterate_until_satisfied').addEventListener('change', function(event) {
            const maxIterationsInput = document.getElementById('max_iterations');
            if (event.target.checked) {
                maxIterationsInput.style.opacity = '0.5';
                maxIterationsInput.title = 'Disabled when iterating until satisfied';
            } else {
                maxIterationsInput.style.opacity = '1';
                maxIterationsInput.title = '';
            }
        });
    </script>
</body>
</html>
