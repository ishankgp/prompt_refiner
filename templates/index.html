<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Refiner</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 1em;
        }
        .result {
            margin-top: 2em;
            border: 1px solid #ccc;
            padding: 1em;
        }
        .result h3 {
            margin-top: 0;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 0.8em 1.5em;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button:hover {
            background-color: #f5f5f5;
        }
        .tab-button.active {
            border-bottom-color: #1976d2 !important;
        }
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1em;
            margin-bottom: 1em;
        }
        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Prompt Refiner</h1>
    <form id="refine-form">
        <label for="prompt">Initial Prompt:</label><br>
        <textarea id="prompt" name="prompt" required></textarea><br>
        <label for="attachments">Attachments (webpage.txt loaded as default):</label><br>
        <small style="color: #666; margin-bottom: 0.5em; display: block;">ğŸ“ Default attachment from webpage.txt is automatically loaded. You can modify or replace this content.</small>
        <textarea id="attachments" name="attachments">{{ default_attachment }}</textarea><br>

        <h3>Parameters</h3>
        <label for="model">Model:</label>
        <select id="model" name="model">
            <option value="gpt-4o" selected>gpt-4o</option>
            <option value="gpt-4o-mini">gpt-4o-mini (cost-effective)</option>
            <option value="gpt-5-turbo" style="color: #1976d2; font-weight: bold;">ğŸ†• gpt-5-turbo (latest)</option>
            <option value="gpt-5" style="color: #1976d2; font-weight: bold;">ğŸ†• gpt-5 (premium)</option>
            <option value="gpt-4-turbo">gpt-4-turbo</option>
            <option value="gpt-4">gpt-4</option>
            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        </select>
        <br>
        <label for="temperature">Temperature:</label>
        <input type="range" id="temperature" name="temperature" min="0" max="2" step="0.1" value="1">
        <span id="temperature-value">1.0</span>
        <br>
        <label for="max_tokens">Max Tokens:</label>
        <input type="number" id="max_tokens" name="max_tokens" value="6000">
        <br>
        <label for="max_iterations">Max Iterations:</label>
        <input type="number" id="max_iterations" name="max_iterations" value="5" min="1" max="10">
        <br>
        <label for="iterate_until_satisfied">
            <input type="checkbox" id="iterate_until_satisfied" name="iterate_until_satisfied">
            Iterate until satisfaction is achieved (ignore max iterations)
        </label>
        <small style="color: #666; display: block; margin-left: 1.2em; margin-top: 0.2em;">âš ï¸ This may result in many iterations and higher costs</small>
        <br>

        <label for="review_prompt">Custom Review Prompt (optional):</label>
        <textarea id="review_prompt" name="review_prompt" placeholder="Provide your own review checklist/prompt. If blank, the app will generate one."></textarea><br>

        <button type="submit">Refine Prompt</button>
    </form>

    <div id="status" aria-live="polite" style="margin-top: 1em;"></div>
    <div id="progress-log" style="margin-top: 1em; background: #f5f5f5; padding: 1em; border-radius: 4px; max-height: 300px; overflow-y: auto; display: none;">
        <h4>Progress Log:</h4>
        <div id="log-content"></div>
    </div>

    <div id="results" class="result" style="display:none;">
        <h3 style="color: #1b5e20;">ğŸ¯ Refinement Results</h3>
        
        <!-- Tab Navigation -->
        <div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 1em;">
            <button class="tab-button active" onclick="showTab('final-tab', this)" style="background: none; border: none; padding: 0.8em 1.5em; cursor: pointer; font-weight: bold; border-bottom: 3px solid #1976d2;">ğŸ“„ Final Result</button>
            <button class="tab-button" onclick="showTab('comparison-tab', this)" style="background: none; border: none; padding: 0.8em 1.5em; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent;">ğŸ” What Changed</button>
            <button class="tab-button" onclick="showTab('history-tab', this)" style="background: none; border: none; padding: 0.8em 1.5em; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent;">ğŸ“Š Full History</button>
        </div>
        
        <!-- Final Result Tab -->
        <div id="final-tab" class="tab-content">
            <h4 style="color: #1b5e20;">ğŸ¯ Final Refined Prompt:</h4>
            <div id="refined-prompt" style="background: #f0f8ff; padding: 1em; border-radius: 4px; border-left: 4px solid #1976d2; margin-bottom: 1em; font-family: monospace; white-space: pre-wrap;"></div>
        </div>
        
        <!-- Comparison Tab -->
        <div id="comparison-tab" class="tab-content" style="display: none;">
            <h4 style="color: #1b5e20;">ğŸ” Original vs Refined Comparison:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1em;">
                <div>
                    <h5 style="color: #d32f2f; margin-bottom: 0.5em;">âŒ Original Prompt:</h5>
                    <div id="original-prompt" style="background: #fff3e0; padding: 1em; border-radius: 4px; border-left: 4px solid #ff9800; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div>
                    <h5 style="color: #1b5e20; margin-bottom: 0.5em;">âœ… Refined Prompt:</h5>
                    <div id="refined-prompt-comparison" style="background: #f0f8ff; padding: 1em; border-radius: 4px; border-left: 4px solid #1976d2; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
            <div id="diff-summary" style="background: #f5f5f5; padding: 1em; border-radius: 4px; margin-top: 1em;">
                <h5 style="margin-top: 0;">ğŸ“ˆ Summary of Changes:</h5>
                <div id="change-stats"></div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history-tab" class="tab-content" style="display: none;">
            <h4 style="color: #1b5e20;">ğŸ“Š Detailed Refinement History:</h4>
            <div id="history" style="margin-top: 1em;"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        document.getElementById('temperature').addEventListener('input', function(event) {
            document.getElementById('temperature-value').textContent = event.target.value;
        });

        // Handle iterate until satisfied checkbox
        document.getElementById('iterate_until_satisfied').addEventListener('change', function(event) {
            const maxIterationsInput = document.getElementById('max_iterations');
            if (event.target.checked) {
                maxIterationsInput.style.opacity = '0.5';
                maxIterationsInput.title = 'Disabled when iterating until satisfied';
            } else {
                maxIterationsInput.style.opacity = '1';
                maxIterationsInput.title = '';
            }
        });

        const form = document.getElementById('refine-form');
        let socket = null;
        
        function initializeSocket() {
            if (socket) return socket;
            socket = io();
            
            socket.on('progress', function(data) {
                const statusEl = document.getElementById('status');
                statusEl.style.color = '#333';
                statusEl.innerHTML = `â³ ${data.message}`;
                addLogEntry(data.message, data.emoji || 'ğŸ“');
            });
            
            socket.on('error', function(data) {
                const statusEl = document.getElementById('status');
                statusEl.style.color = '#b00020';
                statusEl.textContent = 'Error: ' + data.message;
                addLogEntry('âŒ ' + data.message, 'âŒ');
                resetForm();
            });
            
            socket.on('complete', function(data) {
                handleComplete(data);
                resetForm();
            });
            
            return socket;
        }
        
        function resetForm() {
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Refine Prompt';
        }
        
        function addLogEntry(message, emoji = 'ğŸ“') {
            const logContent = document.getElementById('log-content');
            const entry = document.createElement('div');
            entry.style.marginBottom = '0.5em';
            entry.innerHTML = `${emoji} ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function showTab(tabId, buttonElement) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.style.borderBottomColor = 'transparent';
                button.classList.remove('active');
            });
            
            // Show selected tab and mark button as active
            document.getElementById(tabId).style.display = 'block';
            buttonElement.style.borderBottomColor = '#1976d2';
            buttonElement.classList.add('active');
        }
        
        function calculateDifference(original, refined) {
            const originalWords = original.split(/\s+/).length;
            const refinedWords = refined.split(/\s+/).length;
            const wordDiff = refinedWords - originalWords;
            
            const originalLines = original.split('\n').length;
            const refinedLines = refined.split('\n').length;
            const lineDiff = refinedLines - originalLines;
            
            // Simple character-based changes estimate
            const originalChars = original.length;
            const refinedChars = refined.length;
            const charDiff = refinedChars - originalChars;
            
            return {
                wordDiff,
                lineDiff,
                charDiff,
                wordChange: ((wordDiff / originalWords) * 100).toFixed(1),
                sizeChange: ((charDiff / originalChars) * 100).toFixed(1)
            };
        }
        
        function highlightKeyChanges(original, refined) {
            // Simple highlighting of major structural changes
            const changes = [];
            
            // Check for new sections/headers
            const originalHeaders = original.match(/\*\*[^*]+\*\*/g) || [];
            const refinedHeaders = refined.match(/\*\*[^*]+\*\*/g) || [];
            
            const newHeaders = refinedHeaders.filter(h => !originalHeaders.includes(h));
            if (newHeaders.length > 0) {
                changes.push(`Added ${newHeaders.length} new section(s): ${newHeaders.slice(0, 2).map(h => h.replace(/\*\*/g, '')).join(', ')}${newHeaders.length > 2 ? '...' : ''}`);
            }
            
            // Check for structural improvements
            if (refined.includes('### ') && !original.includes('### ')) {
                changes.push('Improved structure with clearer section headings');
            }
            
            if (refined.length > original.length * 1.2) {
                changes.push('Significantly expanded with more detailed instructions');
            } else if (refined.length < original.length * 0.8) {
                changes.push('Streamlined and made more concise');
            }
            
            // Check for specific improvements
            if (refined.includes('Clinical Implications') && !original.includes('Clinical Implications')) {
                changes.push('Added clinical implications section');
            }
            
            if (refined.includes('Safety Information') && !original.includes('Safety Information')) {
                changes.push('Enhanced safety information guidelines');
            }
            
            return changes.length > 0 ? changes : ['General improvements to clarity and structure'];
        }
        
        function handleComplete(data) {
            addLogEntry(`âœ… Processing complete! Generated ${data.iterations} iteration(s)`, 'ğŸ‰');
            
            const escapeHtml = (unsafe) => {
                return unsafe
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;');
            };
            
            // Get the original prompt from the first iteration or form
            const originalPrompt = data.history && data.history.length > 0 
                ? data.history[0].prompt 
                : document.getElementById('prompt').value;
            
            // Populate Final Result Tab
            const refinedPromptEl = document.getElementById('refined-prompt');
            refinedPromptEl.textContent = data.refined_prompt;
            
            // Populate Comparison Tab
            const originalPromptEl = document.getElementById('original-prompt');
            const refinedPromptComparisonEl = document.getElementById('refined-prompt-comparison');
            originalPromptEl.textContent = originalPrompt;
            refinedPromptComparisonEl.textContent = data.refined_prompt;
            
            // Calculate and display differences
            const diff = calculateDifference(originalPrompt, data.refined_prompt);
            const keyChanges = highlightKeyChanges(originalPrompt, data.refined_prompt);
            
            const changeStatsEl = document.getElementById('change-stats');
            changeStatsEl.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em; margin-bottom: 1em;">
                    <div style="background: #e3f2fd; padding: 0.8em; border-radius: 4px;">
                        <strong>ğŸ“ Length Change:</strong><br>
                        ${diff.charDiff > 0 ? '+' : ''}${diff.charDiff} characters (${diff.sizeChange > 0 ? '+' : ''}${diff.sizeChange}%)
                    </div>
                    <div style="background: #f3e5f5; padding: 0.8em; border-radius: 4px;">
                        <strong>ğŸ“ Word Count:</strong><br>
                        ${diff.wordDiff > 0 ? '+' : ''}${diff.wordDiff} words (${diff.wordChange > 0 ? '+' : ''}${diff.wordChange}%)
                    </div>
                    <div style="background: #e8f5e8; padding: 0.8em; border-radius: 4px;">
                        <strong>ğŸ“‹ Structure:</strong><br>
                        ${diff.lineDiff > 0 ? '+' : ''}${diff.lineDiff} lines
                    </div>
                </div>
                <div style="background: #fff3e0; padding: 1em; border-radius: 4px;">
                    <strong>ğŸ¯ Key Improvements:</strong>
                    <ul style="margin: 0.5em 0;">
                        ${keyChanges.map(change => `<li>${change}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            // Populate History Tab
            const historyDiv = document.getElementById('history');
            historyDiv.innerHTML = '';

            // Show each iteration
            data.history.forEach((item, index) => {
                const iterationDiv = document.createElement('div');
                iterationDiv.style.borderBottom = '1px solid #eee';
                iterationDiv.style.paddingBottom = '1em';
                iterationDiv.style.marginBottom = '1em';
                iterationDiv.style.backgroundColor = '#fafafa';
                iterationDiv.style.padding = '1em';
                iterationDiv.style.borderRadius = '4px';
                iterationDiv.innerHTML = `
                    <h4 style="color: #1976d2;">ğŸ”„ Iteration ${index + 1}</h4>
                    <div style="margin-bottom: 1em;">
                        <strong>ğŸ“ Current Prompt:</strong>
                        <div style="background: #f5f5f5; padding: 0.5em; margin-top: 0.5em; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${escapeHtml(item.prompt)}</div>
                    </div>
                    <div style="margin-bottom: 1em;">
                        <strong>ğŸ¯ Review Criteria:</strong>
                        <div style="background: #fff3e0; padding: 0.5em; margin-top: 0.5em; border-radius: 4px; max-height: 150px; overflow-y: auto;">${escapeHtml(item.review_prompt)}</div>
                    </div>
                    <div style="margin-bottom: 1em;">
                        <strong>ğŸ“‹ Analysis & Critique:</strong>
                        <div style="background: ${item.critique.includes('SATISFIED') ? '#e8f5e8' : '#fff8e1'}; padding: 0.5em; margin-top: 0.5em; border-radius: 4px; max-height: 150px; overflow-y: auto;">${escapeHtml(item.critique)}</div>
                    </div>
                `;
                historyDiv.appendChild(iterationDiv);
            });
            
            // Show results and update status
            document.getElementById('results').style.display = 'block';
            const suffix = data.satisfied ? 'prompt satisfied âœ¨' : 'stopped at max iterations â¹ï¸';
            const statusEl = document.getElementById('status');
            statusEl.style.color = '#1b5e20';
            statusEl.innerHTML = `âœ… <strong>Complete!</strong> ${data.iterations} iteration(s), ${suffix}<br>
                ğŸ“Š Model: ${data.model} | ğŸŒ¡ï¸ Temp: ${data.temperature} | ğŸ”¢ Max tokens: ${data.max_tokens}<br>
                ${data.saved_file ? `ğŸ’¾ Saved as: ${data.saved_file}` : ''}`;
            addLogEntry(`ğŸ Refinement complete: ${data.iterations} iterations, ${suffix}`, 'ğŸ¯');
            if (data.saved_file) {
                addLogEntry(`ğŸ’¾ Saved to file: ${data.saved_file}`, 'ğŸ’¾');
            }
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('refine-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const prompt = document.getElementById('prompt').value;
            const attachments = document.getElementById('attachments').value;
            const model = document.getElementById('model').value;
            const temperature = document.getElementById('temperature').value;
            const max_tokens = document.getElementById('max_tokens').value;
            const max_iterations = document.getElementById('max_iterations').value;
            const review_prompt = document.getElementById('review_prompt').value;

            const statusEl = document.getElementById('status');
            statusEl.style.color = '#333';
            statusEl.innerHTML = 'â³ Starting refinement process...';
            
            const progressLog = document.getElementById('progress-log');
            const logContent = document.getElementById('log-content');
            progressLog.style.display = 'block';
            logContent.innerHTML = '';
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const oldBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Refiningâ€¦';

            // Always use WebSocket streaming for real-time updates
            addLogEntry(`ğŸš€ Starting real-time refinement with ${model}`, 'ğŸš€');
            const socket = initializeSocket();
            
            socket.emit('start_refinement', {
                prompt,
                attachments,
                model,
                temperature,
                max_tokens,
                max_iterations,
                review_prompt,
                iterate_until_satisfied: document.getElementById('iterate_until_satisfied').checked
            });
        });
    </script>
</body>
</html>                response = await fetch('/refine', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        prompt, 
                        attachments,
                        model,
                        temperature,
                        max_tokens,
                        max_iterations,
                        review_prompt
                    })
                });

                addLogEntry('Server response received, processing...', 'ğŸ“¨');
                const data = await response.json();

                if (response.ok) {
                    addLogEntry(`âœ… Processing complete! Generated ${data.iterations} iteration(s)`, 'ğŸ‰');
                    
                    const escapeHtml = (unsafe) => {
                        return unsafe
                            .replaceAll('&', '&amp;')
                            .replaceAll('<', '&lt;')
                            .replaceAll('>', '&gt;');
                    };
                    
                    // Show the refined prompt prominently
                    const refinedPromptEl = document.getElementById('refined-prompt');
                    refinedPromptEl.textContent = data.refined_prompt;
                    
                    // Show history
                    const historyDiv = document.getElementById('history');
                    historyDiv.innerHTML = '';

                    // Show each iteration with a small delay for better UX
                    for (let index = 0; index < data.history.length; index++) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                        addLogEntry(`ğŸ“„ Displaying iteration ${index + 1} details...`, 'ï¿½');
                        
                        const item = data.history[index];
                        const iterationDiv = document.createElement('div');
                        iterationDiv.style.borderBottom = '1px solid #eee';
                        iterationDiv.style.paddingBottom = '1em';
                        iterationDiv.style.marginBottom = '1em';
                        iterationDiv.style.backgroundColor = '#fafafa';
                        iterationDiv.style.padding = '1em';
                        iterationDiv.style.borderRadius = '4px';
                        iterationDiv.innerHTML = `
                            <h4 style="color: #1976d2;">ğŸ”„ Iteration ${index + 1}</h4>
                            <div style="margin-bottom: 1em;">
                                <strong>ğŸ“ Current Prompt:</strong>
                                <div style="background: #f5f5f5; padding: 0.5em; margin-top: 0.5em; border-radius: 4px; font-family: monospace; white-space: pre-wrap;">${escapeHtml(item.prompt)}</div>
                            </div>
                            <div style="margin-bottom: 1em;">
                                <strong>ğŸ¯ Review Criteria:</strong>
                                <div style="background: #fff3e0; padding: 0.5em; margin-top: 0.5em; border-radius: 4px;">${escapeHtml(item.review_prompt)}</div>
                            </div>
                            <div style="margin-bottom: 1em;">
                                <strong>ğŸ“‹ Analysis & Critique:</strong>
                                <div style="background: ${item.critique.includes('SATISFIED') ? '#e8f5e8' : '#fff8e1'}; padding: 0.5em; margin-top: 0.5em; border-radius: 4px;">${escapeHtml(item.critique)}</div>
                            </div>
                        `;
                        historyDiv.appendChild(iterationDiv);
                    }
                    
                    document.getElementById('results').style.display = 'block';
                    const suffix = data.satisfied ? 'prompt satisfied âœ¨' : 'stopped at max iterations â¹ï¸';
                    statusEl.style.color = '#1b5e20';
                    statusEl.innerHTML = `âœ… <strong>Complete!</strong> ${data.iterations} iteration(s), ${suffix}<br>
                        ğŸ“Š Model: ${data.model} | ğŸŒ¡ï¸ Temp: ${data.temperature} | ğŸ”¢ Max tokens: ${data.max_tokens}`;
                    addLogEntry(`ï¿½ Refinement complete: ${data.iterations} iterations, ${suffix}`, 'ï¿½');
                    
                    // Scroll to results
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                } else {
                    statusEl.style.color = '#b00020';
                    statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
                    addLogEntry('âŒ ' + (data.error || 'Unknown error'), 'âŒ');
                }
            } catch (e) {
                statusEl.style.color = '#b00020';
                statusEl.textContent = 'Network error. Please try again.';
                addLogEntry('Network error: ' + e.message, 'âŒ');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = oldBtnText;
        });
    </script>
</body>
</html>
